---
import SiteHeader from "../components/SiteHeader.astro";
import { getLangFromUrl, langPrefix, t } from "../i18n";
import type { Lang } from "../i18n";
import { getSiteSettings } from "../utils/settings";
import { ClientRouter } from 'astro:transitions';

const settings = await getSiteSettings();
const { title = settings.siteTitle, description = settings.siteDescription } = Astro.props;
const lang: Lang = getLangFromUrl(Astro.url);
const prefix = langPrefix(lang);
const year = new Date().getFullYear();
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <ClientRouter />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={settings.siteTitle} />
    <meta name="theme-color" content="#fbfaf7" id="meta-theme" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="Lumen Arkh√© RSS" href="/rss.xml" />

    <!-- Google Fonts: Inter + Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/styles/atomo.css" />

    <!-- Dark mode: restore preference before paint (DARK DEFAULT) -->
    <script is:inline>
      (function(){
        var t = localStorage.getItem('theme');
        // Solo si el usuario pidi√≥ expl√≠citamente light, lo activamos. Si no, es dark.
        if (t === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
          var m = document.getElementById('meta-theme');
          if (m) m.content = '#fbfaf7';
        } else {
          // Default: Dark
          document.documentElement.setAttribute('data-theme', 'dark');
          var m = document.getElementById('meta-theme');
          if (m) m.content = '#0f1117';
        }
      })();
    </script>
  </head>

  <body>
    <div class="a-wrap">
      <SiteHeader />
      <slot />

      <footer class="a-foot">
        <div class="a-foot__grid">
          <div>
            <div class="a-foot__brand">Lumen Arkh√©</div>
            <p class="a-foot__desc">
              {t("foot.desc", lang)}
            </p>
          </div>
          <div>
            <div class="a-foot__heading">{t("foot.secciones", lang)}</div>
            <ul class="a-foot__links">
              <li><a href={`${prefix}/articulos?sec=Ensayos`}>{t("nav.ensayos", lang)}</a></li>
              <li><a href={`${prefix}/articulos?sec=Rese√±as`}>{t("nav.resenas", lang)}</a></li>
              <li><a href={`${prefix}/articulos?sec=Cr√≥nica`}>{t("nav.cronica", lang)}</a></li>
              <li><a href={`${prefix}/pdf`}>{t("nav.archivo", lang)}</a></li>
            </ul>
          </div>
          <div>
            <div class="a-foot__heading">{t("foot.mas", lang)}</div>
            <ul class="a-foot__links">
              <li><a href={`${prefix}/newsletter`}>{t("nav.newsletter", lang)}</a></li>
              <li><a href={`${prefix}/sobre`}>{t("foot.sobre", lang)}</a></li>
              <li><a href="https://gregorioaugusto.substack.com" target="_blank" rel="noreferrer">Substack</a></li>
            </ul>
          </div>
        </div>
        <div class="a-foot__copy">¬© {year} Lumen Arkh√©. {t("foot.derechos", lang)}</div>
      </footer>
    </div>

    <!-- Back to top -->
    <button class="a-backtop" id="backtop" aria-label="Volver arriba" title="‚Üë">‚Üë</button>

    <!-- Global scripts -->
    <script>
      function initApp() {
        // Back to top
        (function(){
          var btn = document.getElementById('backtop');
          if (!btn) return;
          
          window.addEventListener('scroll', function(){
            btn.classList.toggle('is-visible', window.scrollY > 400);
          }, {passive: true});
          
          btn.onclick = function(){
            window.scrollTo({top: 0, behavior: 'smooth'});
          };
        })();

        // Dark mode toggle (DARK DEFAULT)
        (function(){
          var btn = document.getElementById('themeToggle');
          if (!btn) return;
          
          function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || 'dark';
          }
          
          function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            // El √≠cono muestra lo que PASAR√Å al hacer click:
            // Si estamos en dark, mostramos ‚òÄÔ∏è (cambiar a light)
            // Si estamos en light, mostramos üåô (cambiar a dark)
            btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            btn.setAttribute('aria-label', theme === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro');
            var m = document.getElementById('meta-theme');
            if (m) m.content = theme === 'dark' ? '#0f1117' : '#fbfaf7';
          }
          
          // Sincronizar estado inicial
          var currentTheme = getCurrentTheme();
          setTheme(currentTheme);
          
          btn.onclick = function(){
            var current = getCurrentTheme();
            var newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
          };
        })();
      }

      // Ejecutar en carga inicial y en cada navegaci√≥n de Astro
      document.addEventListener('astro:page-load', initApp);
    </script>

  </body>
</html>
