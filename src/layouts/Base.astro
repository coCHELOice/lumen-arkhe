---
import SiteHeader from "../components/SiteHeader.astro";
import { getLangFromUrl, langPrefix, t } from "../i18n";
import type { Lang } from "../i18n";
import { getSiteSettings } from "../utils/settings";
import { ClientRouter } from 'astro:transitions';

const settings = await getSiteSettings();
const { title = settings.siteTitle, description = settings.siteDescription } = Astro.props;
const lang: Lang = getLangFromUrl(Astro.url);
const prefix = langPrefix(lang);
const year = new Date().getFullYear();
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <ClientRouter />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={settings.siteTitle} />
    <meta name="theme-color" content="#fbfaf7" id="meta-theme" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="Lumen Arkh√© RSS" href="/rss.xml" />

    <!-- Google Fonts: Inter + Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/styles/atomo.css" />

    <!-- Dark mode: restore preference before paint -->
    <script is:inline>
      (function(){
        var t = localStorage.getItem('theme');
        if (t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.setAttribute('data-theme', 'dark');
          var m = document.getElementById('meta-theme');
          if (m) m.content = '#0f1117';
        }
      })();
    </script>
  </head>

  <body>
    <div class="a-wrap">
      <SiteHeader />
      <slot />

      <footer class="a-foot">
        <div class="a-foot__grid">
          <div>
            <div class="a-foot__brand">Lumen Arkh√©</div>
            <p class="a-foot__desc">
              {t("foot.desc", lang)}
            </p>
          </div>
          <div>
            <div class="a-foot__heading">{t("foot.secciones", lang)}</div>
            <ul class="a-foot__links">
              <li><a href={`${prefix}/articulos?sec=Ensayos`}>{t("nav.ensayos", lang)}</a></li>
              <li><a href={`${prefix}/articulos?sec=Rese√±as`}>{t("nav.resenas", lang)}</a></li>
              <li><a href={`${prefix}/articulos?sec=Cr√≥nica`}>{t("nav.cronica", lang)}</a></li>
              <li><a href={`${prefix}/pdf`}>{t("nav.archivo", lang)}</a></li>
            </ul>
          </div>
          <div>
            <div class="a-foot__heading">{t("foot.mas", lang)}</div>
            <ul class="a-foot__links">
              <li><a href={`${prefix}/newsletter`}>{t("nav.newsletter", lang)}</a></li>
              <li><a href={`${prefix}/sobre`}>{t("foot.sobre", lang)}</a></li>
              <li><a href="https://gregorioaugusto.substack.com" target="_blank" rel="noreferrer">Substack</a></li>
            </ul>
          </div>
        </div>
        <div class="a-foot__copy">¬© {year} Lumen Arkh√©. {t("foot.derechos", lang)}</div>
      </footer>
    </div>

    <!-- Back to top -->
    <button class="a-backtop" id="backtop" aria-label="Volver arriba" title="‚Üë">‚Üë</button>

    <!-- Global scripts -->
    <script is:inline>
      // Back to top
      (function(){
        var btn = document.getElementById('backtop');
        if (!btn) return;
        window.addEventListener('scroll', function(){
          btn.classList.toggle('is-visible', window.scrollY > 400);
        }, {passive: true});
        btn.addEventListener('click', function(){
          window.scrollTo({top: 0, behavior: 'smooth'});
        });
      })();

      // Dark mode toggle
      (function(){
        var btn = document.getElementById('themeToggle');
        if (!btn) return;
        function setTheme(dark) {
          document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
          localStorage.setItem('theme', dark ? 'dark' : 'light');
          btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
          var m = document.getElementById('meta-theme');
          if (m) m.content = dark ? '#0f1117' : '#fbfaf7';
        }
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        btn.addEventListener('click', function(){
          var cur = document.documentElement.getAttribute('data-theme') === 'dark';
          setTheme(!cur);
        });
      })();
    </script>
  </body>
</html>
