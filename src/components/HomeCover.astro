﻿---
import { getCollection } from "astro:content";
import { getLangFromUrl, langPrefix, t } from "../i18n";
import type { Lang } from "../i18n";

const lang: Lang = getLangFromUrl(Astro.url);
const prefix = langPrefix(lang);
const siteTitle = "Lumen Arkhé";

const FALLBACK_IMG = "/images/hero/fallback.jpg";
const heroBySlug = (slug) => `/images/hero/${slug}.jpg`;

// 1) Leer artículos reales
const entries = await getCollection("articulos");
const published = entries
  .filter((e) => !e.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// 2) Hero/Slide: featured primero; si hay menos de 4, completa con recientes
let heroSource = published.filter((e) => e.data.featured).slice(0, 4);

if (heroSource.length < 4) {
  const picked = new Set(heroSource.map((e) => e.slug));
  const fill = published
    .filter((e) => !picked.has(e.slug))
    .slice(0, 4 - heroSource.length);

  heroSource = heroSource.concat(fill);
}

if (heroSource.length === 0) heroSource = published.slice(0, 4);

// 3) Normalizar featuredItems
const featuredItems = heroSource.map((e) => ({
  slug: e.slug,
  title: e.data.title,
  excerpt: e.data.deck ?? e.data.description ?? "",
  author: e.data.author ?? siteTitle,
  href: `${prefix}/articulos/${e.slug}`,
  image: e.data.hero ?? heroBySlug(e.slug),
}));

// 4) "Artículos destacados": últimos 3 (con imágenes)
const latest = published.slice(0, 3).map((e) => ({
  title: e.data.title,
  deck: e.data.deck ?? e.data.description ?? "",
  date: e.data.date.toISOString().slice(0, 10),
  href: `${prefix}/articulos/${e.slug}`,
  tag: e.data.tag ?? e.data.section,
  image: e.data.hero ?? heroBySlug(e.slug),
}));

// PDF / Número actual (hardcoded o dinámico según prefieras, aquí uso el último issue si existe)
// Para simplificar, usaremos un hardcoded example o intentaremos buscar un issue.
const issuePromo = {
  title: "Lumen Arkhé N°0", 
  desc: "Edición de lanzamiento. Ensayos sobre política, técnica y vida pública.",
  href: `${prefix}/print/issue-0`, 
};

// 5) Temas: de la data real (máx 8)
const temas = Array.from(new Set(published.flatMap((e) => e.data.temas ?? []))).slice(0, 8);

// 6) Serie destacada: detectar la serie con más artículos
const seriesMap = new Map<string, typeof published>();
for (const e of published) {
  const parts = e.slug.split("-");
  if (parts.length >= 3) {
    // Try a prefix like "soberania-termica"
    const candidate = parts.slice(0, 2).join("-");
    const matching = published.filter(
      (a) => a.slug.startsWith(candidate + "-") && !a.slug.endsWith("-indice")
    );
    if (matching.length >= 3 && !seriesMap.has(candidate)) {
      seriesMap.set(candidate, matching);
    }
  }
}
let featuredSeries: { title: string; slug: string; count: number; href: string } | null = null;
for (const [prefix_slug, arts] of seriesMap) {
  // Find the index article for a nice title  
  const indexArticle = published.find((e) => e.slug === prefix_slug + "-indice");
  const seriesTitle = indexArticle?.data.title ?? arts[0].data.title.split(":")[0];
  if (!featuredSeries || arts.length > featuredSeries.count) {
    featuredSeries = {
      title: seriesTitle,
      slug: prefix_slug,
      count: arts.length,
      href: indexArticle ? `${prefix}/articulos/${indexArticle.slug}` : `${prefix}/articulos/${arts[0].slug}`,
    };
  }
}

// 7) Carrusel: últimos 8 (excluyendo los 3 destacados)
const latestSlugs = new Set(heroSource.map((e) => e.slug));
const carouselItems = published
  .filter((e) => !latestSlugs.has(e.slug))
  .slice(0, 8)
  .map((e) => ({
    slug: e.slug,
    title: e.data.title,
    section: e.data.section,
    date: e.data.date.toISOString().slice(0, 10),
    href: `${prefix}/articulos/${e.slug}`,
    image: e.data.hero ?? heroBySlug(e.slug),
  }));

// Textos traducidos
const tAbrir = lang === "es" ? "Abrir" : "Open";
const tDestacado = t("hero.destacado", lang);
const tDestacados = t("hero.destacados", lang);
const tSerieEnCurso = lang === "es" ? "Serie en curso" : "Current series";
const tCapitulos = lang === "es" ? "capítulos" : "chapters";
const tRecientes = lang === "es" ? "Artículos recientes" : "Recent articles";
---

<!-- Newsletter popup (cada 15 días) -->
<div
  class="nlpop"
  id="nlpop"
  hidden
  role="dialog"
  aria-modal="true"
  aria-labelledby="nlpop-title"
>
  <div class="nlpop__backdrop" data-close></div>

  <div class="nlpop__panel" role="document">
    <button class="nlpop__x" type="button" aria-label={t("nl.cerrar", lang)} data-close>×</button>

    <h2 id="nlpop-title" class="nlpop__h">{t("nl.titulo", lang)}</h2>
    <p class="nlpop__p">{t("nl.desc", lang)}</p>

    <div class="nlpop__frame" id="nlpopFrame" aria-label={t("nl.form_label", lang)}></div>

    <p class="nlpop__alt">
      {t("nl.alt", lang)}
      <a href="https://gregorioaugusto.substack.com/subscribe" target="_blank" rel="noreferrer">
        {t("nl.alt_link", lang)}
      </a>.
    </p>
  </div>
</div>

<script is:inline>
  (() => {
    const KEY = "lumen_newsletter_popup_ts_v1";
    const TTL_MS = 15 * 24 * 60 * 60 * 1000;
    const DELAY_MS = 900;

    const now = Date.now();
    let last = 0;

    try { last = Number(localStorage.getItem(KEY) || "0"); } catch {}

    if (last && (now - last) < TTL_MS) return;

    const el = document.getElementById("nlpop");
    const frame = document.getElementById("nlpopFrame");
    if (!el) return;

    const ensureIframe = () => {
      if (!frame || frame.firstElementChild) return;

      const iframe = document.createElement("iframe");
      iframe.src = "https://gregorioaugusto.substack.com/embed";
      iframe.width = "480";
      iframe.height = "320";
      iframe.loading = "lazy";
      iframe.setAttribute("style", "border:1px solid #EEE; background:white;");
      iframe.setAttribute("frameborder", "0");
      iframe.setAttribute("scrolling", "no");
      iframe.title = "Substack";

      frame.appendChild(iframe);
    };

    const open = () => {
      try { localStorage.setItem(KEY, String(Date.now())); } catch {}
      ensureIframe();
      el.hidden = false;
      document.documentElement.classList.add("nlpop-open");
    };

    const close = () => {
      el.hidden = true;
      document.documentElement.classList.remove("nlpop-open");
    };

    const t = window.setTimeout(open, DELAY_MS);

    el.addEventListener("click", (e) => {
      const target = e.target;
      if (target && target.dataset && ("close" in target.dataset)) close();
    });

    document.addEventListener("keydown", (e) => {
      if (!el.hidden && e.key === "Escape") close();
    });

    window.addEventListener("beforeunload", () => window.clearTimeout(t));
  })();
</script>

<section class="a-hero" data-variant="split" aria-label={tDestacado}>
  <a class="a-hero__img" href={featuredItems[0].href} aria-label={featuredItems[0].title}>
    <img
      src={featuredItems[0].image}
      alt=""
      loading="lazy"
      decoding="async"
      onerror="this.onerror=null;this.src='/images/hero/fallback.jpg';"
    />
  </a>

  <div class="a-hero__card" id="heroCard" aria-label={tAbrir}>
    <a class="a-hero__hit" href={featuredItems[0].href} aria-label={`${tAbrir}: ${featuredItems[0].title}`}></a>

    <div class="a-hero__lines" id="heroDots" role="tablist" aria-label={tDestacados}>
      {featuredItems.map((_, i) => (
        <button
          class={`a-dotbtn ${i === 0 ? "is-on" : ""}`}
          type="button"
          data-i={i}
          aria-label={`${tDestacado} ${i + 1}`}
        >
          <span></span>
        </button>
      ))}
    </div>

    <h1 class="a-hero__h1">{featuredItems[0].title}</h1>
    <p class="a-hero__p">{featuredItems[0].excerpt}</p>

    <div class="a-hero__rule" aria-hidden="true"></div>
    <div class="a-hero__by">{String(featuredItems[0].author).toUpperCase()}</div>
  </div>

  <script type="application/json" id="heroData" set:html={JSON.stringify(featuredItems)}></script>
  <script type="application/json" id="heroLang" set:html={JSON.stringify({ abrir: tAbrir })}></script>

  <script is:inline data-astro-rerun>
    (() => {
      const dataEl = document.getElementById("heroData");
      const langEl = document.getElementById("heroLang");
      let data = [];
      let langData = { abrir: "Abrir" };
      try { data = JSON.parse(dataEl?.textContent || "[]"); } catch {}
      try { langData = JSON.parse(langEl?.textContent || "{}"); } catch {}
      if (!Array.isArray(data) || !data.length) return;

      const root = document.querySelector(".a-hero");
      if (!root) return;

      const hit = root.querySelector(".a-hero__hit");
      const title = root.querySelector(".a-hero__h1");
      const excerpt = root.querySelector(".a-hero__p");
      const by = root.querySelector(".a-hero__by");
      const imgLink = root.querySelector(".a-hero__img");
      const img = root.querySelector(".a-hero__img img");
      const dots = Array.from(root.querySelectorAll('#heroDots button[data-i]'));

      let idx = 0;

      const render = (animate) => {
        const it = data[idx];

        if (animate) {
          root.classList.add("a-hero--fading");
          setTimeout(() => {
            updateContent(it);
            root.classList.remove("a-hero--fading");
          }, 350);
        } else {
          updateContent(it);
        }

        dots.forEach((b, i) => b.classList.toggle("is-on", i === idx));
      };

      const updateContent = (it) => {
        if (hit) {
          hit.setAttribute("href", it.href);
          hit.setAttribute("aria-label", `${langData.abrir}: ${it.title}`);
        }
        if (title) title.textContent = it.title;
        if (excerpt) excerpt.textContent = it.excerpt;
        if (by) by.textContent = String(it.author || "").toUpperCase();

        if (imgLink) {
          imgLink.setAttribute("href", it.href);
          imgLink.setAttribute("aria-label", it.title);
        }
        if (img) {
          img.onerror = () => { img.onerror = null; img.src = "/images/hero/fallback.jpg"; };
          img.setAttribute("src", it.image || "/images/hero/fallback.jpg");
        }
      };

      dots.forEach((b) => {
        b.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const n = Number(b.getAttribute("data-i"));
          if (Number.isFinite(n) && n !== idx) { idx = n; render(true); }
        };
      });

      const KEY = "__lumenHeroTimer";
      const stop = () => {
        if (window[KEY]) { clearInterval(window[KEY]); window[KEY] = null; }
      };
      const start = () => {
        stop();
        window[KEY] = setInterval(() => {
          idx = (idx + 1) % data.length;
          render(true);
        }, 9000);
      };

      root.addEventListener("mouseenter", stop);
      root.addEventListener("mouseleave", start);
      root.addEventListener("focusin", stop);
      root.addEventListener("focusout", start);
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) stop();
        else start();
      });

      render(false);
      start();
    })();
  </script>
</section>

<!-- Serie destacada -->
{featuredSeries && (
  <section class="a-section">
    <a class="a-featured-series" href={featuredSeries.href} style="text-decoration:none;">
      <span class="a-featured-series__badge">{tSerieEnCurso}</span>
      <div class="a-featured-series__info">
        <div class="a-featured-series__title">{featuredSeries.title}</div>
        <p class="a-featured-series__desc">{featuredSeries.count} {tCapitulos}</p>
      </div>
      <div class="a-featured-series__progress" title={`${featuredSeries.count} ${tCapitulos}`}>
        <div class="a-featured-series__bar" style={`width: ${Math.min(100, (featuredSeries.count / 8) * 100)}%`}></div>
      </div>
    </a>
  </section>
)}

<section class="a-section">
  <div class="a-section__row">
    <h2 class="a-section__h2">{t("home.articulos_destacados", lang)}</h2>
    <div class="a-section__rule" aria-hidden="true"></div>
  </div>

  <ul class="a-feat-grid">
    {latest.map((p, i) => (
      <li class="a-feat-item">
        <div class="a-feat-item__content">
           <a class="a-feat-item__meta" href={p.href}>
            <span>{p.tag}</span>
            <span class="a-dot">•</span>
            <span>{p.date}</span>
          </a>
          <a class="a-feat-item__title" href={p.href}>{p.title}</a>
          <div class="a-feat-item__deck">{p.deck}</div>
        </div>
        <a class="a-feat-item__img" href={p.href} aria-hidden="true" tabindex="-1">
          <img
            src={p.image}
            alt=""
            loading="lazy"
            decoding="async"
            onerror="this.onerror=null;this.src='/images/hero/fallback.jpg';"
          />
        </a>
      </li>
    ))}
  </ul>

  <div class="a-topics">
    <span class="a-topics__t">{t("home.temas", lang)}</span>
    {temas.map((tema, i) => (
      <>
        <a class="a-topics__a" href={`${prefix}/articulos?tema=${encodeURIComponent(tema)}`}>{tema}</a>
        {i < temas.length - 1 ? <span class="a-dot">•</span> : null}
      </>
    ))}
  </div>
</section>

<!-- Banner Suscríbete (CTA) -->
<section class="a-section">
  <div class="a-cta-subscribe">
    <h3 class="a-cta-subscribe__h">{t("nl.titulo", lang)}</h3>
    <p class="a-cta-subscribe__p">
      {t("nl.desc", lang)}<br/>
      {lang === "es" ? "Únete a nuestra comunidad de lectores." : "Join our community of readers."}
    </p>
    <a class="a-cta-btn" href="https://gregorioaugusto.substack.com/subscribe" target="_blank" rel="noreferrer">
      <span>{lang === "es" ? "Suscribirse" : "Subscribe"}</span>
      <span>→</span>
    </a>
  </div>
</section>

<!-- Promo Issue / PDF -->
<section class="a-section">
  <a class="a-issue-promo" href={issuePromo.href} target="_blank">
    <div class="a-issue-promo__cover">
       <div class="css-cover">
          <div class="css-cover__issue">N°0</div>
          <div class="css-cover__circle">
            <div class="css-cover__line"></div>
          </div>
          <div class="css-cover__title">LUMEN ARKHÉ</div>
       </div>
    </div>
    <div class="a-issue-promo__info">
      <span class="a-issue-promo__label">{lang === "es" ? "NÚMERO ACTUAL" : "CURRENT ISSUE"}</span>
      <h3 class="a-issue-promo__title">{issuePromo.title}</h3>
      <p class="a-issue-promo__desc">{issuePromo.desc}</p>
      <span class="a-issue-promo__cta">{t("pdf.ver_numero", lang)} →</span>
    </div>
  </a>
</section>

<!-- Carrusel horizontal: artículos recientes -->
{carouselItems.length > 0 && (
  <section class="a-section">
    <div class="a-carousel">
      <h2 class="a-carousel__h">{tRecientes}</h2>
      <div class="a-carousel__track">
        {carouselItems.map((item) => (
          <a class="a-carousel__card" href={item.href}>
            <img
              class="a-carousel__thumb"
              src={item.image}
              alt=""
              loading="lazy"
              decoding="async"
              onerror="this.onerror=null;this.src='/images/hero/fallback.jpg';"
            />
            <div class="a-carousel__body">
              <div class="a-carousel__card-title">{item.title}</div>
              <div class="a-carousel__card-meta">{item.section} • {item.date}</div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
)}
