---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

// 1) Traemos todos los art√≠culos una sola vez
const entries = await getCollection("articulos");

// 2) Generamos p√°ginas SOLO para los que no son borrador
export async function getStaticPaths() {
  const entries = await getCollection("articulos");
  const published = entries.filter((e) => !e.data.draft);
  return published.map((e) => ({ params: { slug: e.slug } }));
}

// 3) Resolvemos el art√≠culo actual por slug
const { slug } = Astro.params;
const entry = entries.find((e) => e.slug === slug);
if (!entry) throw new Error("Art√≠culo no encontrado");
const { Content, remarkPluginFrontmatter } = await entry.render();

const siteTitle = "Lumen Arkh√©";
const title = entry.data.title;
const deck = String(entry.data.deck ?? entry.data.description ?? entry.data.excerpt ?? "");
const section = entry.data.section ?? "";
const author = entry.data.author ?? "";
const date = entry.data.date ? entry.data.date.toLocaleDateString("es-CL") : "";
const workTitle = String(entry.data.workTitle ?? "");
const workAuthor = String(entry.data.workAuthor ?? "");
const workYear = String(entry.data.workYear ?? "");
const workUrl = String(entry.data.workUrl ?? "");

const chroniclePlace = String(entry.data.chroniclePlace ?? "");
const chronicleDateRaw = String(entry.data.chronicleDate ?? "");
const chronicleCase = String(entry.data.chronicleCase ?? "");

const chronicleDateText = (() => {
  if (!chronicleDateRaw) return "";
  const d = new Date(chronicleDateRaw);
  return Number.isNaN(d.getTime()) ? "" : d.toLocaleDateString("es-CL");
})();

// Tiempo de lectura estimado (~220 palabras/min)
const body = entry.body ?? "";
const wordCount = body.split(/\s+/).filter(Boolean).length;
const readingTime = Math.max(1, Math.round(wordCount / 220));

// Art√≠culos relacionados (mismo tema o secci√≥n, excluir actual)
const temas: string[] = (entry.data as any).temas ?? [];
const published = entries.filter((e) => !e.data.draft && e.slug !== slug);
const related = published
  .map((e) => {
    let score = 0;
    if (e.data.section === section) score += 1;
    const eTemas: string[] = (e.data as any).temas ?? [];
    for (const t of temas) { if (eTemas.includes(t)) score += 2; }
    return { entry: e, score };
  })
  .filter((r) => r.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3)
  .map((r) => r.entry);

const articleUrl = `https://lumenarkhe.com/articulos/${slug}`;
---

<Base title={`${title} ‚Äî ${siteTitle}`} description={deck}>
  <!-- Scroll progress bar -->
  <div class="a-progress" id="scrollProgress"></div>

  <article class="a-article">
      <div class="a-article__meta">
        {section ? <span>{section}</span> : null}
        {date ? <><span class="a-dot">‚Ä¢</span><span>{date}</span></> : null}
        {author ? <><span class="a-dot">‚Ä¢</span><span>{author}</span></> : null}
        <span class="a-dot">‚Ä¢</span>
        <span class="a-reading-time">~{readingTime} min</span>
      </div>

      {/* Hero opcional en art√≠culo */}
      <figure class="a-article__hero">
        <img
          src={(entry.data.hero ?? `/images/hero/${entry.slug}.jpg`)}
          alt=""
          loading="lazy"
          decoding="async"
          onerror="this.onerror=null;this.src='/images/hero/fallback.jpg';"
        />
      </figure>

      <h1 class="a-article__h1">{title}</h1>
      {deck ? <p class="a-article__deck">{deck}</p> : null}
      
{section === "Rese√±as" && (workTitle || workAuthor || workYear || workUrl) ? (
  <div class="a-article__meta">
    <span>Obra</span>
    {workTitle ? <><span class="a-dot">‚Ä¢</span><span>{workTitle}</span></> : null}
    {workAuthor ? <><span class="a-dot">‚Ä¢</span><span>{workAuthor}</span></> : null}
    {workYear ? <><span class="a-dot">‚Ä¢</span><span>{workYear}</span></> : null}
    {workUrl ? <><span class="a-dot">‚Ä¢</span><a href={workUrl} target="_blank" rel="noreferrer">Link</a></> : null}
  </div>
) : null}

{section === "Cr√≥nica" && (chroniclePlace || chronicleDateText || chronicleCase) ? (
  <div class="a-article__meta">
    <span>Hecho</span>
    {chroniclePlace ? <><span class="a-dot">‚Ä¢</span><span>{chroniclePlace}</span></> : null}
    {chronicleDateText ? <><span class="a-dot">‚Ä¢</span><span>{chronicleDateText}</span></> : null}
    {chronicleCase ? <><span class="a-dot">‚Ä¢</span><span>{chronicleCase}</span></> : null}
  </div>
) : null}


      <div class="a-prose">
        <Content />
      </div>

      <!-- Share -->
      <div class="a-share">
        <span class="a-share__label">Compartir</span>
        <a class="a-share__btn" href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(articleUrl)}`} target="_blank" rel="noreferrer" title="Compartir en X" aria-label="Compartir en X">ùïè</a>
        <a class="a-share__btn" href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(articleUrl)}`} target="_blank" rel="noreferrer" title="Compartir en LinkedIn" aria-label="Compartir en LinkedIn">in</a>
        <button class="a-share__btn" id="copyLink" type="button" title="Copiar enlace" aria-label="Copiar enlace">üîó</button>
      </div>

      <!-- Related articles -->
      {related.length > 0 && (
        <div class="a-related">
          <h2 class="a-related__h">Art√≠culos relacionados</h2>
          <div class="a-related__grid">
            {related.map((r) => (
              <a class="a-related__card" href={`/articulos/${r.slug}`}>
                <div class="a-related__card-title">{r.data.title}</div>
                <div class="a-related__card-meta">
                  {r.data.section}
                  {r.data.date ? ` ‚Ä¢ ${r.data.date.toLocaleDateString("es-CL")}` : ""}
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
    </article>

  <!-- Scroll progress + copy link scripts -->
  <script is:inline>
    // Scroll progress
    (function(){
      var bar = document.getElementById('scrollProgress');
      if (!bar) return;
      window.addEventListener('scroll', function(){
        var h = document.documentElement.scrollHeight - window.innerHeight;
        bar.style.width = h > 0 ? (window.scrollY / h * 100) + '%' : '0%';
      }, {passive: true});
    })();

    // Copy link
    (function(){
      var btn = document.getElementById('copyLink');
      if (!btn) return;
      btn.addEventListener('click', function(){
        navigator.clipboard.writeText(window.location.href).then(function(){
          btn.textContent = '‚úì';
          setTimeout(function(){ btn.textContent = 'üîó'; }, 1500);
        });
      });
    })();
  </script>
</Base>
