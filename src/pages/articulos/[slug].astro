---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

const entries = await getCollection("articulos");

export async function getStaticPaths() {
  const entries = await getCollection("articulos");
  const published = entries.filter((e) => !e.data.draft);
  return published.map((e) => ({ params: { slug: e.slug } }));
}

const { slug } = Astro.params;
const entry = entries.find((e) => e.slug === slug);
if (!entry) throw new Error("Art√≠culo no encontrado");
const { Content } = await entry.render();

const siteTitle = "Lumen Arkh√©";
const title = entry.data.title;
const deck = String(entry.data.deck ?? entry.data.description ?? "");
const section = entry.data.section ?? "";
const author = entry.data.author ?? "";
const dateObj = entry.data.date;
const date = dateObj ? dateObj.toLocaleDateString("es-CL") : "";
const isoDate = dateObj ? dateObj.toISOString() : "";
const workTitle = String(entry.data.workTitle ?? "");
const workAuthor = String(entry.data.workAuthor ?? "");
const workYear = String(entry.data.workYear ?? "");
const workUrl = String(entry.data.workUrl ?? "");

const chroniclePlace = String(entry.data.chroniclePlace ?? "");
const chronicleDateRaw = String(entry.data.chronicleDate ?? "");
const chronicleCase = String(entry.data.chronicleCase ?? "");

const chronicleDateText = (() => {
  if (!chronicleDateRaw) return "";
  const d = new Date(chronicleDateRaw);
  return Number.isNaN(d.getTime()) ? "" : d.toLocaleDateString("es-CL");
})();

// Tiempo de lectura
const body = entry.body ?? "";
const wordCount = body.split(/\s+/).filter(Boolean).length;
const readingTime = Math.max(1, Math.round(wordCount / 220));

// Art√≠culos relacionados
const temas: string[] = (entry.data as any).temas ?? [];
const published = entries.filter((e) => !e.data.draft && e.slug !== slug);
const related = published
  .map((e) => {
    let score = 0;
    if (e.data.section === section) score += 1;
    const eTemas: string[] = (e.data as any).temas ?? [];
    for (const t of temas) { if (eTemas.includes(t)) score += 2; }
    return { entry: e, score };
  })
  .filter((r) => r.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3)
  .map((r) => r.entry);

// Navegaci√≥n de serie (slug contiene patr√≥n: nombre-serie-NN)
const slugParts = slug.split("-");
const seriesPrefix = slugParts.length > 2 ? slugParts.slice(0, -1).join("-") : null;
let seriesPrev: typeof entry | null = null;
let seriesNext: typeof entry | null = null;

if (seriesPrefix) {
  const seriesArticles = entries
    .filter((e) => !e.data.draft && e.slug.startsWith(seriesPrefix) && e.slug !== slug && e.slug !== seriesPrefix + "-indice")
    .sort((a, b) => a.slug.localeCompare(b.slug));
  
  const currentIndex = seriesArticles.findIndex((e) => e.slug === slug);
  if (currentIndex === -1) {
    // Current article might not match the pattern exactly, try by date
    const allSeries = entries
      .filter((e) => !e.data.draft && e.slug.startsWith(seriesPrefix.split("-").slice(0, 2).join("-")))
      .filter((e) => !e.slug.endsWith("-indice"))
      .sort((a, b) => a.slug.localeCompare(b.slug));
    const idx = allSeries.findIndex((e) => e.slug === slug);
    if (idx > 0) seriesPrev = allSeries[idx - 1];
    if (idx >= 0 && idx < allSeries.length - 1) seriesNext = allSeries[idx + 1];
  } else {
    if (currentIndex > 0) seriesPrev = seriesArticles[currentIndex - 1];
    if (currentIndex < seriesArticles.length - 1) seriesNext = seriesArticles[currentIndex + 1];
  }
}

const articleUrl = `https://lumenarkhe.com/articulos/${slug}`;

// JSON-LD structured data
const jsonLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  description: deck,
  author: { "@type": "Person", name: author || "Lumen Arkh√©" },
  publisher: { "@type": "Organization", name: "Lumen Arkh√©" },
  datePublished: isoDate,
  url: articleUrl,
  wordCount: wordCount,
  articleSection: section,
});
---

<Base title={`${title} ‚Äî ${siteTitle}`} description={deck}>
  <!-- JSON-LD -->
  <script type="application/ld+json" set:html={jsonLd} />

  <!-- Scroll progress bar -->
  <div class="a-progress" id="scrollProgress"></div>

  <!-- TOC lateral -->
  <nav class="a-toc" id="articleToc" aria-label="Contenidos">
    <div class="a-toc__title">Contenidos</div>
    <ul class="a-toc__list" id="tocList"></ul>
  </nav>

  <!-- Hero Cinem√°tico -->
  <header class="a-article-hero-cine">
    <div class="a-article-hero-cine__img">
      <img
        src={(entry.data.hero ?? `/images/hero/${entry.slug}.jpg`)}
        alt=""
        loading="eager"
        decoding="async"
        onerror="this.onerror=null;this.src='/images/hero/fallback.jpg';"
      />
    </div>
    <div class="a-article-hero-cine__overlay"></div>
    
    <div class="a-article-hero-cine__content">
      <div class="a-article-hero-cine__meta">
        {section ? <span>{section}</span> : null}
        {date ? <><span class="a-dot">‚Ä¢</span><span>{date}</span></> : null}
        <span class="a-dot">‚Ä¢</span>
        <span>~{readingTime} min</span>
      </div>

      <h1 class="a-article-hero-cine__h1">{title}</h1>
      
      {deck ? <p class="a-article-hero-cine__deck">{deck}</p> : null}

      <div class="a-article__meta" style="justify-content: center; margin-top: 24px; color: rgba(255,255,255,0.8);">
        {author ? <span>Por <strong>{author}</strong></span> : null}
        <span class="a-dot">‚Ä¢</span>
        <button class="a-zen-btn" id="zenToggle" type="button" style="border-color: rgba(255,255,255,0.3); color: white;">üìñ Zen</button>
        <button class="a-bookmark" id="bookmarkBtn" type="button" data-slug={slug} title="Guardar" style="color: white;">üîñ</button>
      </div>
    </div>
  </header>

  <article class="a-article">
      <!-- El t√≠tulo y deck ya est√°n en el hero, as√≠ que los quitamos de aqu√≠ -->


{section === "Rese√±as" && (workTitle || workAuthor || workYear || workUrl) ? (
  <div class="a-article__meta">
    <span>Obra</span>
    {workTitle ? <><span class="a-dot">‚Ä¢</span><span>{workTitle}</span></> : null}
    {workAuthor ? <><span class="a-dot">‚Ä¢</span><span>{workAuthor}</span></> : null}
    {workYear ? <><span class="a-dot">‚Ä¢</span><span>{workYear}</span></> : null}
    {workUrl ? <><span class="a-dot">‚Ä¢</span><a href={workUrl} target="_blank" rel="noreferrer">Link</a></> : null}
  </div>
) : null}

{section === "Cr√≥nica" && (chroniclePlace || chronicleDateText || chronicleCase) ? (
  <div class="a-article__meta">
    <span>Hecho</span>
    {chroniclePlace ? <><span class="a-dot">‚Ä¢</span><span>{chroniclePlace}</span></> : null}
    {chronicleDateText ? <><span class="a-dot">‚Ä¢</span><span>{chronicleDateText}</span></> : null}
    {chronicleCase ? <><span class="a-dot">‚Ä¢</span><span>{chronicleCase}</span></> : null}
  </div>
) : null}

      <div class="a-prose" id="proseContent">
        <Content />
      </div>

      <!-- Share -->
      <div class="a-share">
        <span class="a-share__label">Compartir</span>
        <a class="a-share__btn" href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(articleUrl)}`} target="_blank" rel="noreferrer" title="X" aria-label="Compartir en X">ùïè</a>
        <a class="a-share__btn" href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(articleUrl)}`} target="_blank" rel="noreferrer" title="LinkedIn" aria-label="LinkedIn">in</a>
        <button class="a-share__btn" id="copyLink" type="button" title="Copiar enlace" aria-label="Copiar enlace">üîó</button>
      </div>

      <!-- Series navigation -->
      {(seriesPrev || seriesNext) && (
        <nav class="a-series-nav" aria-label="Navegaci√≥n de serie">
          {seriesPrev ? (
            <a class="a-series-nav__link" href={`/articulos/${seriesPrev.slug}`}>
              <div class="a-series-nav__label">‚Üê Anterior</div>
              <div class="a-series-nav__title">{seriesPrev.data.title}</div>
            </a>
          ) : <div></div>}
          {seriesNext ? (
            <a class="a-series-nav__link a-series-nav__link--next" href={`/articulos/${seriesNext.slug}`}>
              <div class="a-series-nav__label">Siguiente ‚Üí</div>
              <div class="a-series-nav__title">{seriesNext.data.title}</div>
            </a>
          ) : null}
        </nav>
      )}

      <!-- Related articles -->
      {related.length > 0 && (
        <div class="a-related">
          <h2 class="a-related__h">Art√≠culos relacionados</h2>
          <div class="a-related__grid">
            {related.map((r) => (
              <a class="a-related__card" href={`/articulos/${r.slug}`}>
                <div class="a-related__card-title">{r.data.title}</div>
                <div class="a-related__card-meta">
                  {r.data.section}
                  {r.data.date ? ` ‚Ä¢ ${r.data.date.toLocaleDateString("es-CL")}` : ""}
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
    </article>

  <script is:inline>
    // Scroll progress
    (function(){
      var bar = document.getElementById('scrollProgress');
      if (!bar) return;
      window.addEventListener('scroll', function(){
        var h = document.documentElement.scrollHeight - window.innerHeight;
        bar.style.width = h > 0 ? (window.scrollY / h * 100) + '%' : '0%';
      }, {passive: true});
    })();

    // Copy link
    (function(){
      var btn = document.getElementById('copyLink');
      if (!btn) return;
      btn.addEventListener('click', function(){
        navigator.clipboard.writeText(window.location.href).then(function(){
          btn.textContent = '‚úì';
          setTimeout(function(){ btn.textContent = 'üîó'; }, 1500);
        });
      });
    })();

    // TOC generation
    (function(){
      var prose = document.getElementById('proseContent');
      var list = document.getElementById('tocList');
      var toc = document.getElementById('articleToc');
      if (!prose || !list || !toc) return;
      var headings = prose.querySelectorAll('h2');
      if (headings.length < 2) return; // no TOC for short articles

      headings.forEach(function(h, i){
        if (!h.id) h.id = 'sec-' + i;
        var li = document.createElement('li');
        li.className = 'a-toc__item';
        li.innerHTML = '<a href="#' + h.id + '">' + h.textContent + '</a>';
        list.appendChild(li);
      });

      toc.classList.add('is-visible');
      var items = list.querySelectorAll('.a-toc__item');

      // Highlight active
      var observer = new IntersectionObserver(function(entries){
        entries.forEach(function(e){
          if (e.isIntersecting) {
            var id = e.target.id;
            items.forEach(function(li){
              var a = li.querySelector('a');
              li.classList.toggle('is-active', a && a.getAttribute('href') === '#' + id);
            });
          }
        });
      }, { rootMargin: '-80px 0px -70% 0px' });

      headings.forEach(function(h){ observer.observe(h); });
    })();

    // Zen mode
    (function(){
      var btn = document.getElementById('zenToggle');
      if (!btn) return;
      btn.addEventListener('click', function(){
        document.documentElement.classList.toggle('zen-mode');
        var isZen = document.documentElement.classList.contains('zen-mode');
        btn.textContent = isZen ? '‚úï Salir' : 'üìñ Zen';
      });
    })();

    // Bookmark
    (function(){
      var btn = document.getElementById('bookmarkBtn');
      if (!btn) return;
      var slug = btn.getAttribute('data-slug');
      var KEY = 'lumen_bookmarks';
      function getBookmarks(){ try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
      function save(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
      var bm = getBookmarks();
      if (bm.some(function(b){ return b.slug === slug; })) btn.classList.add('is-saved');
      btn.addEventListener('click', function(){
        var bm = getBookmarks();
        var idx = bm.findIndex(function(b){ return b.slug === slug; });
        if (idx >= 0) {
          bm.splice(idx, 1);
          btn.classList.remove('is-saved');
        } else {
          bm.push({ slug: slug, title: document.querySelector('.a-article__h1')?.textContent || '', saved: Date.now() });
          btn.classList.add('is-saved');
        }
        save(bm);
      });
    })();

    // Footnote tooltips
    (function(){
      document.querySelectorAll('.a-prose a[href^="#fn"]').forEach(function(a){
        a.classList.add('footnote-ref');
        a.addEventListener('mouseenter', function(e){
          var href = a.getAttribute('href');
          var target = href ? document.querySelector(href) : null;
          if (!target) return;
          var tip = document.createElement('div');
          tip.className = 'a-footnote-tip';
          tip.textContent = target.textContent?.replace(/‚Ü©.*$/, '').trim() || '';
          tip.style.top = (e.pageY - 50) + 'px';
          tip.style.left = Math.min(e.pageX, window.innerWidth - 340) + 'px';
          document.body.appendChild(tip);
          a._tip = tip;
        });
        a.addEventListener('mouseleave', function(){
          if (a._tip) { a._tip.remove(); a._tip = null; }
        });
      });
    })();
  </script>
</Base>
