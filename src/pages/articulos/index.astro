---
export const prerender = false;

import Base from "../../layouts/Base.astro";

type AnyPost = { slug: string; data: any; render?: () => Promise<{ Content: any }> };

function toDateSafe(v: any): Date | null {
  if (!v) return null;
  if (v instanceof Date) return v;
  const d = new Date(String(v));
  return isNaN(d.getTime()) ? null : d;
}
function fmtDate(v: any): string {
  const d = toDateSafe(v);
  if (!d) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function norm(v: any): string {
  return String(v ?? "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toLowerCase();
}

let posts: AnyPost[] = [];
try {
  const { getCollection } = await import("astro:content");
  const entries = await getCollection("articulos");
  posts = entries.map((e: any) => ({ slug: e.slug, data: e.data ?? {}, render: e.render?.bind(e) }));
} catch {
  const modules = import.meta.glob("/src/content/articulos/**/*.{md,mdx}", { eager: true }) as Record<string, any>;
  posts = Object.entries(modules).map(([path, mod]) => {
    const slug = path.split("/").pop()?.replace(/\.(md|mdx)$/i, "") ?? path;
    const data = mod.frontmatter ?? mod.metadata ?? {};
    return { slug, data };
  });
}

posts.sort((a, b) => {
  const da = toDateSafe(a.data.date) ?? new Date(0);
  const db = toDateSafe(b.data.date) ?? new Date(0);
  return db.getTime() - da.getTime();
});

const secRaw = Astro.url.searchParams.get("sec");
const temaRaw = Astro.url.searchParams.get("tema");
const q = (Astro.url.searchParams.get("q") || "").trim().toLowerCase();

const sec = norm(secRaw);
const tema = norm(temaRaw);

const filtered = posts.filter((p) => {
  if (p.data?.draft) return false;

  const sectionRaw = String(p.data.section ?? p.data.seccion ?? "");
  const section = norm(sectionRaw);

  const tagsStrRaw = String(p.data.tag ?? p.data.tema ?? "");
  const tagsStr = norm(tagsStrRaw);

  const tagsArrRaw = Array.isArray(p.data.temas)
    ? p.data.temas
    : Array.isArray(p.data.tags)
    ? p.data.tags
    : [];
  const tagsArr = tagsArrRaw.map((t: any) => norm(t));

  const title = String(p.data.title ?? "");
  const deck = String(p.data.deck ?? p.data.description ?? p.data.excerpt ?? "");
  const hay = `${title} ${deck} ${sectionRaw} ${tagsStrRaw} ${tagsArrRaw.join(" ")}`.toLowerCase();

  if (sec && section !== sec) return false;
  if (tema && !(tagsStr.includes(tema) || tagsArr.includes(tema))) return false;
  if (q && !hay.includes(q)) return false;
  return true;
});

const siteTitle = "Lumen Arkhé";
const sections = [
  { label: "Ensayos", href: "/articulos?sec=Ensayos" },
  { label: "Reseñas", href: "/articulos?sec=Reseñas" },
  { label: "Crónica", href: "/articulos?sec=Crónica" },
];
const extras = [
  { label: "Archivo PDF", href: "/pdf" },
  { label: "Newsletter", href: "/newsletter" },
];
---

<Base title={`Artículos — ${siteTitle}`} description="Archivo de textos.">
  <div class="wrap">
    <div class="topbar">
      <div class="lang">
        <a class="on" href="#">ES</a><span class="dot">•</span><a class="off" href="#">EN</a>
      </div>
      <a href="#" style="text-decoration:none;opacity:.85">Ingresa</a>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:baseline;gap:16px;margin-top:10px">
      <a class="brand" href="/"><b>{siteTitle}</b><span>Revista / Archivo</span></a>
      <nav class="nav" aria-label="Secciones">
        {sections.map((i) => <a href={i.href}>{i.label}</a>)}
        <span class="sep" aria-hidden="true"> · </span>
        {extras.map((i) => <a href={i.href}>{i.label}</a>)}
      </nav>
    </div>

    <div class="search">
      <form method="get" action="/articulos">
        {secRaw ? <input type="hidden" name="sec" value={secRaw} /> : null}
        {temaRaw ? <input type="hidden" name="tema" value={temaRaw} /> : null}
        <input type="text" name="q" value={q} placeholder="Búsqueda" />
        <button type="submit">Buscar</button>
      </form>
      {(secRaw || temaRaw || q) ? <a class="small" href="/articulos">Limpiar filtros</a> : null}
    </div>

    <hr class="rule" />

    <h1>Artículos</h1>
    {(secRaw || temaRaw || q) ? (
      <p class="lede">
