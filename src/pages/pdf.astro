---
import Base from "../layouts/Base.astro";
import { getCollection } from "astro:content";

const siteTitle = "Lumen Arkhé";
const showExport = import.meta.env.DEV;

// ordena por fecha desc (soporta Date o string)
const time = (v) => (v instanceof Date ? v.getTime() : new Date(v).getTime());

const issuesRaw = await getCollection("issues");
const issues = issuesRaw
  .slice()
  .sort((a, b) => time(b.data.date) - time(a.data.date))
   .map((e) => ({
    id: e.id,
    title: e.data.title,
    period: e.data.period ?? "",
    cover: e.data.cover ?? "/images/hero/fallback.jpg",
    buyUrl: e.data.buyUrl ?? "",
    pdf: e.data.pdf ?? "",
  }));

---

<Base title={`PDF — ${siteTitle}`} description="Números semestrales listos para imprimir / vender.">
  <main class="a-wrap">
    <header class="a-archive__head">
      <div class="a-kicker">ARCHIVO</div>
      <h1 class="a-archive__title">PDF</h1>
      <p class="a-archive__sub">Números semestrales listos para imprimir / vender.</p>
    </header>

    <section class="a-issues">
      {issues.length === 0 ? (
        <p style="opacity:.75">Aún no hay números publicados.</p>
      ) : (
        issues.map((it) => (
          <article class="a-issueCard">
            <div class="a-issueCard__cover">
              <img src={it.cover} alt="" loading="lazy" decoding="async" />
            </div>

            <div class="a-issueCard__body">
              <div class="a-issueCard__meta">
                <span class="a-issueCard__period">{it.period}</span>
              </div>

              <h2 class="a-issueCard__title">{it.title}</h2>

              <div class="a-issueCard__actions">
  {it.pdf ? (
    <a class="a-btn" href={it.pdf} target="_blank" rel="noreferrer">Abrir PDF</a>
  ) : null}

  <a class="a-btn" href={`/issue/${it.id}`}>Ver número</a>


                {showExport ? (
                  <a class="a-btn" href={`/issue/${it.id}?print=1`}>Exportar PDF</a>
                ) : null}

                {it.buyUrl ? (
                  <a class="a-btn a-btn--primary" href={it.buyUrl} target="_blank" rel="noreferrer">
                    Comprar
                  </a>
                ) : null}
              </div>

              <p class="a-issueCard__note">
                Los artículos siguen disponibles en web. El PDF es la edición maquetada (colección).
              </p>
            </div>
          </article>
        ))
      )}
    </section>
  </main>

  <style>
    .a-wrap{ max-width: 980px; margin: 0 auto; padding: 48px 18px; }
    .a-archive__head{ margin-bottom: 22px; }
    .a-kicker{ letter-spacing: .18em; font-size: 11px; opacity: .7; }
    .a-archive__title{ font-size: 48px; line-height: 1.02; margin: 6px 0 8px; }
    .a-archive__sub{ max-width: 56ch; opacity: .75; margin: 0; }

    .a-issues{ display: grid; gap: 12px; margin-top: 26px; }
    .a-issueCard{
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 14px;
      border: 1px solid rgba(0,0,0,.12);
      padding: 12px;
      background: rgba(255,255,255,.3);
    }
    .a-issueCard__cover{
      width: 140px; height: 86px; overflow: hidden;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.04);
    }
    .a-issueCard__cover img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    .a-issueCard__meta{ display:flex; gap:10px; align-items:center; opacity:.75; font-size: 12px; }
    .a-issueCard__title{ margin: 6px 0 8px; font-size: 18px; line-height: 1.2; }
    .a-issueCard__actions{ display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 8px; }
    .a-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 7px 10px; border: 1px solid rgba(0,0,0,.22);
      text-decoration:none; font-size: 13px;
      background: rgba(255,255,255,.35);
    }
    .a-btn--primary{ background: rgba(0,0,0,.85); color: #fff; border-color: rgba(0,0,0,.85); }
    .a-issueCard__note{ margin: 0; opacity:.68; font-size: 12px; max-width: 70ch; }

    @media (max-width: 640px){
      .a-issueCard{ grid-template-columns: 1fr; }
      .a-issueCard__cover{ width: 100%; height: 140px; }
    }
  </style>
</Base>

