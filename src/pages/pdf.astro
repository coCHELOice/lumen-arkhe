---
import Base from "../layouts/Base.astro";
import { getCollection } from "astro:content";

const siteTitle = "Lumen Arkhé";
const showExport = import.meta.env.DEV;

// ordena por fecha desc (soporta Date o string)
const time = (v) => (v instanceof Date ? v.getTime() : new Date(v).getTime());

const issuesRaw = await getCollection("issues").catch(() => []);
const issues = issuesRaw
  .slice()
  .sort((a, b) => time(b.data.date) - time(a.data.date))
   .map((e) => ({
    id: e.slug,
    title: e.data.title,
    period: e.data.period ?? "",
    cover: e.data.cover ?? "",
    buyUrl: e.data.buyUrl ?? "",
    pdf: e.data.pdf ?? "",
    href: `/issue/${e.slug}`
  }));

// Inyectar manualmente el Número 0 si no está en la colección
if (!issues.find(i => i.title.includes("N°0"))) {
  issues.unshift({
    id: "issue-0",
    title: "Lumen Arkhé N°0",
    period: "Febrero 2026",
    cover: "", // Usaremos CSS cover
    buyUrl: "",
    pdf: "/print/issue-0", // Link directo a la versión de impresión
    href: "/print/issue-0",
    description: "Edición de lanzamiento. Ensayos sobre política, técnica y vida pública."
  });
}

const docsRaw = await getCollection("documentos").catch(() => []);
const docs = docsRaw.sort((a,b) => time(b.data.date) - time(a.data.date));


---

<Base title={`PDF — ${siteTitle}`} description="Números semestrales listos para imprimir / vender.">
  <main class="a-wrap">
    <header class="a-archive__head">
      <div class="a-kicker">ARCHIVO</div>
      <h1 class="a-archive__title">PDF</h1>
      <p class="a-archive__sub">Números semestrales listos para imprimir / vender.</p>
    </header>

    <section class="a-issues">
      {issues.length === 0 ? (
        <p style="opacity:.75">Aún no hay números publicados.</p>
      ) : (
        issues.map((it) => (
          <article class="a-issueCard">
            <a class="a-issueCard__cover" href={it.href} target={it.pdf ? "_blank" : undefined}>
              {it.cover ? (
                <img src={it.cover} alt="" loading="lazy" decoding="async" />
              ) : (
                <div class="css-cover">
                  <div class="css-cover__issue">N°0</div>
                  <div class="css-cover__circle">
                    <div class="css-cover__line"></div>
                  </div>
                  <div class="css-cover__title">LUMEN ARKHÉ</div>
                </div>
              )}
            </a>

            <div class="a-issueCard__body">
              <div class="a-issueCard__meta">
                <span class="a-issueCard__period">{it.period}</span>
              </div>

              <h2 class="a-issueCard__title">
                <a href={it.href} style="text-decoration:none; color:inherit;" target={it.pdf ? "_blank" : undefined}>
                  {it.title}
                </a>
              </h2>
              {it.description && <p class="a-issueCard__deck">{it.description}</p>}

              <div class="a-issueCard__actions">
  {it.pdf ? (
    <a class="a-btn" href={it.pdf} target="_blank" rel="noreferrer">Abrir PDF / Impresión web</a>
  ) : null}

                {it.buyUrl ? (
                  <a class="a-btn a-btn--primary" href={it.buyUrl} target="_blank" rel="noreferrer">
                    Comprar
                  </a>
                ) : null}
              </div>

              <p class="a-issueCard__note">
                El PDF es la edición maquetada para impresión (colección).
              </p>
            </div>
          </article>
        ))
      )}
    </section>

    {/* Sección de Documentos Adicionales */}
    {docs.length > 0 && (
      <section class="a-docs-section">
        <h2 class="a-archive__title" style="font-size: 32px; margin-top: 60px;">Documentos</h2>
        <div class="a-docs-grid">
          {docs.map((d) => (
            <a class="a-doc-card" href={d.data.file} target="_blank" rel="noreferrer">
               <div class="a-doc-card__icon">PDF</div>
               <div class="a-doc-card__main">
                  <h3 class="a-doc-card__title">{d.data.title}</h3>
                  <div class="a-doc-card__meta">
                    {d.data.date.toLocaleDateString("es-ES", {year:'numeric', month:'long'})}
                    {d.data.author && ` • ${d.data.author}`}
                  </div>
                  {d.data.description && <p class="a-doc-card__desc">{d.data.description}</p>}
               </div>
               <div class="a-doc-card__arrow">→</div>
            </a>
          ))}
        </div>
      </section>
    )}
  </main>

  <style>
    /* ... (estilos anteriores) ... */
    
    /* Estilos nuevos docs */
    .a-docs-grid { display: grid; gap: 16px; margin-top: 24px; }
    .a-doc-card {
      display: flex; align-items: flex-start; gap: 16px;
      padding: 20px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 8px;
      text-decoration: none;
      color: #111;
      transition: all .2s;
    }
    .a-doc-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .a-doc-card__icon {
      font-size: 10px; font-weight: bold; background: #eee; padding: 4px 6px; border-radius: 4px;
    }
    .a-doc-card__main { flex: 1; }
    .a-doc-card__title { font-size: 18px; margin: 0 0 4px; font-family: var(--serif); line-height:1.2; }
    .a-doc-card__meta { font-size: 12px; opacity: .6; text-transform: uppercase; letter-spacing: .05em; margin-bottom: 6px; }
    .a-doc-card__desc { font-size: 14px; opacity: .75; margin: 0; max-width: 65ch; }
    .a-doc-card__arrow { opacity: .4; font-size: 20px; }

    /* ... */
    .a-wrap{ max-width: 980px; margin: 0 auto; padding: 48px 18px; }
    .a-archive__head{ margin-bottom: 22px; }
    .a-kicker{ letter-spacing: .18em; font-size: 11px; opacity: .7; }
    .a-archive__title{ font-size: 48px; line-height: 1.02; margin: 6px 0 8px; }
    .a-archive__sub{ max-width: 56ch; opacity: .75; margin: 0; }

    .a-issues{ display: grid; gap: 24px; margin-top: 26px; }
    .a-issueCard{
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 24px;
      border: 1px solid rgba(0,0,0,.08);
      padding: 24px;
      background: #fff;
      border-radius: 8px;
      color: #111; /* Forzar texto oscuro sobre fondo blanco */
    }
    .a-issueCard__cover{
      width: 160px; aspect-ratio: 3/4; overflow: hidden;
      border: 1px solid rgba(0,0,0,.12);
      background: #eee;
      display: block;
      text-decoration: none;
      position: relative;
    }
    .a-issueCard__cover img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    
    /* CSS Cover styles */
    .css-cover {
      width: 100%; height: 100%;
      background: #fbfaf7;
      display: flex; flex-direction: column;
      align-items: center; justify-content: space-between;
      padding: 10px;
      text-align: center;
      color: #111;
    }
    .css-cover__issue{ font-size: 10px; letter-spacing: 1px; font-weight: bold; }
    .css-cover__title{ font-size: 10px; font-family: serif; letter-spacing: 1px; margin-bottom: 5px; }
    .css-cover__circle {
      width: 60px; height: 60px;
      border: 1px solid #111;
      border-radius: 50%;
      position: relative;
    }
    .css-cover__line {
      width: 1px; height: 100%; background: #111;
      position: absolute; left: 50%; top: 0; transform: translateX(-50%);
    }

    .a-issueCard__meta{ display:flex; gap:10px; align-items:center; opacity:.75; font-size: 12px; text-transform:uppercase; letter-spacing:.05em; }
    .a-issueCard__title{ margin: 8px 0; font-size: 22px; line-height: 1.2; font-family: serif; }
    .a-issueCard__deck{ margin: 0 0 12px; opacity: .8; font-size: 15px; line-height: 1.5; max-width: 60ch; }
    .a-issueCard__actions{ display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 12px; margin-top: auto; }
    .a-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 8px 16px; border: 1px solid rgba(0,0,0,.4); /* Borde más visible */
      text-decoration:none; font-size: 13px;
      color: #111; /* asegurar texto oscuro */
      background: rgba(255,255,255,.35);
      border-radius: 4px;
      transition: all .2s;
    }
    .a-btn:hover { background: #fff; transform: translateY(-1px); }
    .a-btn--primary{ background: #111; color: #fff; border-color: #111; }
    .a-btn--primary:hover{ background: #333; color: #fff; }
    .a-issueCard__note{ margin: 0; opacity:.6; font-size: 12px; max-width: 70ch; }

    @media (max-width: 640px){
      .a-issueCard{ grid-template-columns: 1fr; }
      .a-issueCard__cover{ width: 140px; margin: 0 auto; }
      .a-issueCard__body{ text-align: center; }
      .a-issueCard__actions{ justify-content: center; }
      .a-issueCard__meta{ justify-content: center; }
    }
  </style>
</Base>

